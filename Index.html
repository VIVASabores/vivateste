<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIVA Sabores OS - Gestão de Pizzaria</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Lucide Core (Mais estável para CDN em ficheiro único) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Babel para JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #ef4444; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Componente de Ícone robusto para ambiente CDN
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);

            return <i data-lucide={name} style={{width: size, height: size}} className={`inline-block ${className}`}></i>;
        };

        const App = () => {
            // --- CONFIGURAÇÃO IA ---
            const apiKey = ""; 
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [showAiConsole, setShowAiConsole] = useState(false);
            const [aiPrompt, setAiPrompt] = useState("");

            // --- 1. ESTADO: INSUMOS BASE (Nível 1) ---
            const [rawMaterials, setRawMaterials] = useState([
                { id: 'rm-1', name: 'Farinha 00 Italiana', costPerKg: 10.50, yield: 100 },
                { id: 'rm-2', name: 'Tomate Pelati', costPerKg: 18.00, yield: 95 },
                { id: 'rm-3', name: 'Mussarela Premium', costPerKg: 48.00, yield: 100 },
                { id: 'rm-4', name: 'Azeite Extra Virgem', costPerKg: 75.00, yield: 100 },
            ]);

            // --- 2. ESTADO: BASES / MOLHOS / MASSAS (Nível 2) ---
            const [subRecipes, setSubRecipes] = useState([
                { 
                    id: 'sub-1', 
                    name: 'Massa Fermentação Longa', 
                    outputKg: 1.65, 
                    items: [
                        { materialId: 'rm-1', quantity: 1000 },
                        { materialId: 'rm-4', quantity: 30 }
                    ]
                },
                { 
                    id: 'sub-2', 
                    name: 'Molho de Tomate Base', 
                    outputKg: 2.3,
                    items: [
                        { materialId: 'rm-2', quantity: 2500 },
                        { materialId: 'rm-4', quantity: 80 }
                    ]
                }
            ]);

            // --- 3. ESTADO: CARDÁPIO (Nível 3) ---
            const [menu, setMenu] = useState([
                {
                    id: 'p-1',
                    name: 'Margherita VIVA',
                    category: 'Estrela',
                    price: 69.90,
                    composition: [
                        { type: 'sub', id: 'sub-1', quantity: 350, label: 'Massa' },
                        { type: 'sub', id: 'sub-2', quantity: 90, label: 'Molho' },
                        { type: 'raw', id: 'rm-3', quantity: 280, label: 'Mussarela' }
                    ]
                }
            ]);

            const [view, setView] = useState('menu');
            const [activePizzaId, setActivePizzaId] = useState('p-1');
            const [fixedCosts, setFixedCosts] = useState(12000);
            const [taxes, setTaxes] = useState(6);
            const [fees, setFees] = useState(15);
            const [packaging, setPackaging] = useState(4.50);

            // --- MOTOR DE CÁLCULO EM CASCATA ---
            const materialUnitCosts = useMemo(() => {
                const units = {};
                rawMaterials.forEach(rm => {
                    const realCostPerKg = rm.costPerKg / (rm.yield / 100 || 1);
                    units[rm.id] = realCostPerKg / 1000;
                });
                return units;
            }, [rawMaterials]);

            const subRecipeUnitCosts = useMemo(() => {
                const units = {};
                subRecipes.forEach(sub => {
                    const totalCost = sub.items.reduce((acc, item) => {
                        return acc + ((materialUnitCosts[item.materialId] || 0) * item.quantity);
                    }, 0);
                    const costPerKg = sub.outputKg > 0 ? totalCost / sub.outputKg : 0;
                    units[sub.id] = costPerKg / 1000;
                });
                return units;
            }, [subRecipes, materialUnitCosts]);

            const menuCalculated = useMemo(() => {
                return menu.map(pizza => {
                    const costInsumos = pizza.composition.reduce((acc, item) => {
                        const unitCost = item.type === 'sub' ? subRecipeUnitCosts[item.id] : materialUnitCosts[item.id];
                        return acc + ((unitCost || 0) * item.quantity);
                    }, 0) + packaging;
                    const cmv = pizza.price > 0 ? (costInsumos / pizza.price) * 100 : 0;
                    const margin = pizza.price - costInsumos - (pizza.price * (taxes + fees) / 100);
                    return { ...pizza, costInsumos, cmv, margin };
                });
            }, [menu, subRecipeUnitCosts, materialUnitCosts, packaging, taxes, fees]);

            const activePizza = menuCalculated.find(p => p.id === activePizzaId) || menuCalculated[0];

            // --- FUNÇÕES DE ADIÇÃO MANUAL (CORRIGIDAS) ---
            const handleAddRawMaterial = () => {
                setRawMaterials(prev => [...prev, { id: `rm-${Date.now()}`, name: 'Novo Insumo', costPerKg: 0, yield: 100 }]);
                setView('rm');
            };

            const handleAddSubRecipe = () => {
                setSubRecipes(prev => [...prev, { id: `sub-${Date.now()}`, name: 'Nova Receita Base', outputKg: 1, items: [] }]);
                setView('lab');
            };

            const handleAddPizza = () => {
                const newId = `p-${Date.now()}`;
                setMenu(prev => [...prev, { id: newId, name: 'Nova Pizza Manual', category: 'Burro de Carga', price: 50.00, composition: [] }]);
                setActivePizzaId(newId);
                setView('edit');
            };

            const addComponentToPizza = (type, id, label) => {
                setMenu(prev => prev.map(p => {
                    if (p.id !== activePizzaId) return p;
                    return { ...p, composition: [...p.composition, { type, id, quantity: 0, label }] };
                }));
            };

            // --- LÓGICA DO CHEF AI ---
            const handleChefAi = async () => {
                if (!aiPrompt) return;
                setIsAiLoading(true);
                try {
                    const systemInstruction = `Você é o Chef Consultor VIVA Sabores. Retorne APENAS um JSON no formato:
                    {
                      "action": "add_raw" | "add_base" | "add_pizza",
                      "data": {
                         "name": string,
                         "costPerKg": number,
                         "yield": number,
                         "outputKg": number,
                         "ingredients": [{"name": string, "quantity": number, "isBase": boolean, "suggestedCost": number}]
                      }
                    }`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Comando: "${aiPrompt}"` }] }],
                            systemInstruction: { parts: [{ text: systemInstruction }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    const resData = await response.json();
                    const ai = JSON.parse(resData.candidates[0].content.parts[0].text);

                    if (ai.action === 'add_raw') {
                        setRawMaterials(p => [...p, { id: `rm-ai-${Date.now()}`, name: ai.data.name, costPerKg: ai.data.costPerKg || 0, yield: ai.data.yield || 100 }]);
                        setView('rm');
                    } else if (ai.action === 'add_base') {
                        const items = ai.data.ingredients.map(ing => {
                            let exists = rawMaterials.find(r => r.name.toLowerCase().includes(ing.name.toLowerCase()));
                            const rid = exists ? exists.id : `rm-ai-${Math.random()}`;
                            if (!exists) setRawMaterials(p => [...p, { id: rid, name: ing.name, costPerKg: ing.suggestedCost || 15, yield: 100 }]);
                            return { materialId: rid, quantity: ing.quantity };
                        });
                        setSubRecipes(p => [...p, { id: `sub-ai-${Date.now()}`, name: ai.data.name, outputKg: ai.data.outputKg || 1, items }]);
                        setView('lab');
                    } else if (ai.action === 'add_pizza') {
                        const composition = ai.data.ingredients.map(ing => {
                            if (ing.isBase) {
                                const base = subRecipes.find(s => s.name.toLowerCase().includes(ing.name.toLowerCase()));
                                return { type: 'sub', id: base?.id || 'sub-1', quantity: ing.quantity, label: ing.name };
                            } else {
                                let exists = rawMaterials.find(r => r.name.toLowerCase().includes(ing.name.toLowerCase()));
                                const rid = exists ? exists.id : `rm-ai-${Math.random()}`;
                                if (!exists) setRawMaterials(p => [...p, { id: rid, name: ing.name, costPerKg: ing.suggestedCost || 20, yield: 100 }]);
                                return { type: 'raw', id: rid, quantity: ing.quantity, label: ing.name };
                            }
                        });
                        const pId = `p-ai-${Date.now()}`;
                        setMenu(p => [...p, { id: pId, name: ai.data.name, category: 'Estrela', price: ai.data.price || 65, composition }]);
                        setActivePizzaId(pId);
                        setView('edit');
                    }

                    setAiPrompt("");
                    setShowAiConsole(false);
                } catch (e) { 
                    console.error("AI Error:", e); 
                } finally { 
                    setIsAiLoading(false); 
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8 animate-fade-in bg-slate-950">
                    <div className="max-w-[1400px] mx-auto">
                        
                        {/* HEADER */}
                        <header className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8 mb-12">
                            <div className="flex items-center gap-6">
                                <div className="bg-red-600 p-5 rounded-[2rem] shadow-2xl border border-red-500/50">
                                    <Icon name="brain" size={36} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-4xl font-black tracking-tighter uppercase italic leading-none">VIVA<span className="text-red-600">SABORES</span></h1>
                                    <p className="text-slate-500 text-xs font-bold tracking-[0.3em] mt-2 uppercase italic leading-none">Gestão de Custos v11.3</p>
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap gap-4">
                                <button onClick={() => setShowAiConsole(true)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg flex items-center gap-3 transition-all active:scale-95">
                                    <Icon name="sparkles" size={18} /> Comandar IA
                                </button>
                                <div className="bg-slate-900/40 p-4 rounded-3xl border border-slate-800 flex items-center gap-6 backdrop-blur-xl">
                                    <div className="text-center">
                                        <p className="text-[10px] font-black text-slate-500 uppercase">Pizzas</p>
                                        <p className="text-2xl font-black text-white">{menu.length}</p>
                                    </div>
                                    <div className="h-8 w-[1px] bg-slate-800"></div>
                                    <div className="text-center">
                                        <p className="text-[10px] font-black text-slate-500 uppercase">CMV</p>
                                        <p className="text-2xl font-black text-red-500 italic leading-none">
                                            {(menuCalculated.reduce((a,b) => a + b.cmv, 0) / menuCalculated.length || 0).toFixed(1)}%
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </header>

                        {/* NAV */}
                        <nav className="flex flex-wrap bg-slate-900/80 p-2 rounded-[2.2rem] border border-slate-800 shadow-2xl backdrop-blur-3xl mb-10 w-fit">
                            {[
                                { id: 'rm', label: '1. Insumos', icon: 'package' },
                                { id: 'lab', label: '2. Laboratório', icon: 'flask-conical' },
                                { id: 'menu', label: '3. Cardápio', icon: 'book-open' },
                                { id: 'edit', label: 'Montagem', icon: 'scale' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`flex items-center gap-3 px-8 py-4 rounded-2xl text-[11px] font-black transition-all uppercase tracking-widest ${view === item.id ? 'bg-red-600 text-white shadow-xl scale-105' : 'text-slate-500 hover:text-white'}`}>
                                    <Icon name={item.icon} size={16} /> {item.label}
                                </button>
                            ))}
                        </nav>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                            <div className="lg:col-span-8 space-y-8">
                                
                                {/* VISTA 1: INSUMOS */}
                                {view === 'rm' && (
                                    <div className="bg-slate-900 rounded-[3rem] border border-slate-800 p-8 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-500">
                                        <div className="flex justify-between items-center mb-8">
                                            <h2 className="text-xl font-black text-red-500 uppercase italic">Nível 1: Gestão de Preços</h2>
                                            <button onClick={handleAddRawMaterial} className="bg-slate-800 px-6 py-3 rounded-xl text-xs font-black uppercase border border-slate-700 hover:bg-slate-700 transition-all">+ Novo</button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {rawMaterials.map(rm => (
                                                <div key={rm.id} className="bg-slate-950 p-6 rounded-3xl border border-slate-800 flex justify-between items-center hover:border-red-500/30 transition-all group">
                                                    <div className="flex-1">
                                                        <input type="text" value={rm.name} onChange={e => setRawMaterials(p => p.map(it => it.id === rm.id ? {...it, name: e.target.value} : it))} className="bg-transparent border-none font-bold text-white uppercase outline-none w-full" />
                                                        <div className="flex gap-4 mt-2 text-[10px] font-bold text-slate-500 uppercase">
                                                            <span>Perda: <input type="number" value={100-rm.yield} onChange={e => setRawMaterials(p => p.map(it => it.id === rm.id ? {...it, yield: 100 - parseFloat(e.target.value)} : it))} className="bg-slate-900 w-10 text-center rounded text-orange-500" /> %</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-right flex items-center gap-4">
                                                        <div>
                                                            <p className="text-[9px] font-black text-slate-600 uppercase mb-1">Preço Kg</p>
                                                            <div className="flex items-center bg-slate-900 px-3 py-2 rounded-xl border border-slate-800 shadow-inner">
                                                                <span className="text-xs text-slate-600 mr-1 italic font-black">R$</span>
                                                                <input type="number" value={rm.costPerKg} onChange={e => setRawMaterials(p => p.map(it => it.id === rm.id ? {...it, costPerKg: parseFloat(e.target.value) || 0} : it))} className="bg-transparent w-16 text-right font-mono font-black" />
                                                            </div>
                                                        </div>
                                                        <button onClick={() => setRawMaterials(p => p.filter(it => it.id !== rm.id))} className="text-slate-800 hover:text-red-500 transition-colors"><Icon name="trash-2" size={18} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* VISTA 2: LABORATÓRIO */}
                                {view === 'lab' && (
                                    <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-500">
                                        <div className="flex justify-center">
                                            <button onClick={handleAddSubRecipe} className="bg-blue-600 hover:bg-blue-500 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl">+ Nova Receita Base</button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            {subRecipes.map(sub => {
                                                const costPerKg = (subRecipeUnitCosts[sub.id] || 0) * 1000;
                                                return (
                                                    <div key={sub.id} className="bg-slate-900 rounded-[3rem] border border-slate-800 overflow-hidden shadow-2xl flex flex-col group">
                                                        <div className="p-8 bg-slate-800/30 border-b border-slate-700 flex justify-between items-center">
                                                            <input type="text" value={sub.name} onChange={e => setSubRecipes(prev => prev.map(s => s.id === sub.id ? {...s, name: e.target.value} : s))} className="bg-transparent border-none p-0 text-xl font-black italic uppercase text-blue-500 focus:ring-0 w-full" />
                                                            <div className="text-right shrink-0 ml-4 leading-none">
                                                                <p className="text-[10px] font-black text-slate-500 uppercase italic mb-1">Custo Kg</p>
                                                                <p className="text-2xl font-black italic text-white leading-none">R$ {costPerKg.toFixed(2)}</p>
                                                            </div>
                                                        </div>
                                                        <div className="p-8 space-y-3 flex-1">
                                                            {sub.items.map((item, idx) => (
                                                                <div key={idx} className="flex justify-between items-center p-4 bg-slate-950 rounded-2xl border border-slate-800 shadow-inner">
                                                                    <select value={item.materialId} onChange={e => setSubRecipes(p => p.map(s => s.id === sub.id ? {...s, items: s.items.map((it, i) => i === idx ? {...it, materialId: e.target.value} : it)} : s))} className="bg-transparent border-none text-slate-300 font-bold uppercase text-xs outline-none cursor-pointer">
                                                                        {rawMaterials.map(rm => <option key={rm.id} value={rm.id} className="bg-slate-900">{rm.name}</option>)}
                                                                    </select>
                                                                    <div className="flex items-center gap-3">
                                                                        <input type="number" value={item.quantity} onChange={e => setSubRecipes(p => p.map(s => s.id === sub.id ? {...s, items: s.items.map((it, i) => i === idx ? {...it, quantity: parseFloat(e.target.value) || 0} : it)} : s))} className="bg-slate-900 w-16 text-center rounded-lg font-bold text-sm" />
                                                                        <span className="text-xs text-slate-600 font-bold uppercase tracking-widest leading-none">g</span>
                                                                        <button onClick={() => setSubRecipes(p => p.map(s => s.id === sub.id ? {...s, items: s.items.filter((_, i) => i !== idx)} : s))} className="text-slate-800 hover:text-red-500"><Icon name="x" size={14} /></button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            <button onClick={() => setSubRecipes(p => p.map(s => s.id === sub.id ? {...s, items: [...s.items, { materialId: rawMaterials[0]?.id || '', quantity: 0 }]} : s))} className="w-full py-4 border-2 border-dashed border-slate-800 rounded-2xl text-[10px] font-black text-slate-600 hover:text-blue-500 transition-all uppercase tracking-widest mt-2">+ Insumo na Base</button>
                                                        </div>
                                                        <div className="p-6 bg-slate-950 border-t border-slate-800 flex justify-between items-center text-[10px] font-black text-slate-600 uppercase italic">
                                                            <span>Lote: <input type="number" value={sub.outputKg} onChange={e => setSubRecipes(prev => prev.map(s => s.id === sub.id ? {...s, outputKg: parseFloat(e.target.value) || 1} : s))} className="w-14 bg-slate-900 text-center rounded-lg py-1" /> kg</span>
                                                            <button onClick={() => setSubRecipes(prev => prev.filter(s => s.id !== sub.id))} className="text-slate-800 hover:text-red-500 transition-colors"><Icon name="trash-2" size={16}/></button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}

                                {/* VISTA 3: MENU */}
                                {view === 'menu' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in zoom-in duration-500">
                                        <div onClick={handleAddPizza} className="bg-slate-900/50 rounded-[3.5rem] border-4 border-dashed border-slate-800 p-10 flex flex-col items-center justify-center gap-4 hover:border-red-500/50 transition-all cursor-pointer group shadow-2xl">
                                            <Icon name="plus" size={48} className="text-slate-700 group-hover:text-red-500 transition-colors" />
                                            <p className="text-xl font-black uppercase text-slate-600 group-hover:text-white transition-colors tracking-widest leading-none">Nova Pizza Manual</p>
                                        </div>
                                        {menuCalculated.map(pizza => (
                                            <div key={pizza.id} onClick={() => { setActivePizzaId(pizza.id); setView('edit'); }} className="bg-slate-900 rounded-[3.5rem] border border-slate-800 p-10 hover:border-red-500/50 transition-all cursor-pointer group shadow-2xl relative overflow-hidden">
                                                <div className="flex justify-between items-start">
                                                    <h3 className="text-3xl font-black italic text-white group-hover:text-red-500 transition-colors uppercase leading-none">{pizza.name}</h3>
                                                    <button onClick={(e) => { e.stopPropagation(); setMenu(p => p.filter(it => it.id !== pizza.id)); }} className="text-slate-800 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all p-2 leading-none"><Icon name="trash-2" size={20}/></button>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4 mt-8 text-center uppercase tracking-tighter">
                                                    <div className="bg-slate-950 p-6 rounded-3xl border border-slate-900 shadow-inner">
                                                        <p className="text-[9px] font-black text-slate-600 mb-2">CMV Real</p>
                                                        <p className={`text-2xl font-black italic leading-none ${pizza.cmv > 35 ? 'text-red-500' : 'text-green-500'}`}>{pizza.cmv.toFixed(1)}%</p>
                                                    </div>
                                                    <div className="bg-slate-950 p-6 rounded-3xl border border-slate-900 shadow-inner">
                                                        <p className="text-[9px] font-black text-slate-600 mb-2">Margem</p>
                                                        <p className="text-2xl font-black italic text-white tracking-tighter leading-none italic">R$ {pizza.margin.toFixed(2)}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* VISTA 4: MONTAGEM */}
                                {view === 'edit' && (
                                    <div className="bg-slate-900 rounded-[3rem] border border-slate-800 overflow-hidden shadow-2xl animate-in fade-in slide-in-from-left-6 duration-500">
                                        <div className="p-8 border-b border-slate-800 bg-gradient-to-r from-slate-900 to-slate-800/40 flex justify-between items-center gap-4">
                                            <input type="text" value={activePizza.name} onChange={e => setMenu(prev => prev.map(p => p.id === activePizzaId ? {...p, name: e.target.value} : p))} className="bg-transparent border-none text-3xl font-black italic focus:ring-0 text-white uppercase tracking-tighter w-full leading-none" />
                                            <div className="flex gap-2 shrink-0">
                                                <div className="relative group">
                                                    <button className="bg-blue-600 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl">+ Usar Base</button>
                                                    <div className="absolute top-full right-0 mt-2 w-64 bg-slate-900 border border-slate-800 rounded-[1.5rem] shadow-2xl opacity-0 group-hover:opacity-100 transition-all z-50 p-3 space-y-1 pointer-events-none group-hover:pointer-events-auto">
                                                        {subRecipes.map(s => (
                                                            <button key={s.id} onClick={() => addComponentToPizza('sub', s.id, s.name)} className="w-full text-left text-[11px] font-bold p-3 hover:bg-slate-800 rounded-xl transition-all border border-transparent hover:border-blue-500/30">{s.name}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="relative group">
                                                    <button className="bg-slate-800 text-white px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest border border-slate-700">+ Insumo</button>
                                                    <div className="absolute top-full right-0 mt-2 w-64 bg-slate-900 border border-slate-800 rounded-[1.5rem] shadow-2xl opacity-0 group-hover:opacity-100 transition-all z-50 p-3 space-y-1 pointer-events-none group-hover:pointer-events-auto max-h-80 overflow-y-auto">
                                                        {rawMaterials.map(r => (
                                                            <button key={r.id} onClick={() => addComponentToPizza('raw', r.id, r.name)} className="w-full text-left text-[11px] font-bold p-3 hover:bg-slate-800 rounded-xl transition-all border border-transparent hover:border-red-500/30">{r.name}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="p-8 space-y-4 min-h-[400px]">
                                            {activePizza.composition.map((item, idx) => {
                                                const costPerGram = item.type === 'sub' ? subRecipeUnitCosts[item.id] : materialUnitCosts[item.id];
                                                return (
                                                    <div key={idx} className="flex justify-between items-center bg-slate-950 p-6 rounded-[2rem] border border-slate-800 group hover:border-slate-700 transition-all">
                                                        <div className="flex items-center gap-4">
                                                            <button onClick={() => setMenu(prev => prev.map(p => p.id === activePizzaId ? {...p, composition: p.composition.filter((_, i) => i !== idx)} : p))} className="text-slate-800 hover:text-red-500 transition-colors leading-none"><Icon name="trash-2" size={16} /></button>
                                                            <p className={`font-black uppercase text-sm italic tracking-widest ${item.type === 'sub' ? 'text-blue-500' : 'text-slate-200'}`}>{item.label}</p>
                                                        </div>
                                                        <div className="flex items-center gap-6">
                                                            <div className="text-right italic">
                                                                <p className="text-[10px] font-black text-slate-700 uppercase mb-1 leading-none">Custo dose</p>
                                                                <p className="font-mono text-sm font-bold text-slate-500 leading-none">R$ {((costPerGram || 0) * item.quantity).toFixed(2)}</p>
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <input type="number" value={item.quantity} onChange={e => {
                                                                    const newVal = parseFloat(e.target.value) || 0;
                                                                    setMenu(prev => prev.map(p => p.id === activePizzaId ? {...p, composition: p.composition.map((c, i) => i === idx ? {...c, quantity: newVal} : c)} : p));
                                                                }} className="bg-slate-900 border border-slate-800 rounded-xl w-24 text-center font-black text-2xl p-3 focus:border-red-500 outline-none shadow-xl" />
                                                                <span className="text-xs font-black text-slate-700 uppercase tracking-widest leading-none">g</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            {activePizza.composition.length === 0 && <div className="p-20 text-center border-2 border-dashed border-slate-800 rounded-[3rem] text-slate-700 italic font-medium">Monte a pizza adicionando itens acima.</div>}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* SIDEBAR */}
                            <div className="lg:col-span-4 space-y-8 animate-in fade-in slide-in-from-right-6 duration-700">
                                <div className="bg-white text-slate-950 rounded-[4.5rem] shadow-2xl p-12 sticky top-8 border-t-[18px] border-red-600 transition-all overflow-hidden">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.4em] leading-none italic">Análise de Lucro</h3>
                                        <span className="bg-slate-100 text-[9px] font-black px-4 py-1.5 rounded-full text-slate-500 uppercase border border-slate-200">{activePizza.name}</span>
                                    </div>
                                    
                                    <div className="flex items-center gap-2 mb-10">
                                        <span className="text-4xl font-black text-slate-300 italic leading-none tracking-tighter">R$</span>
                                        <input type="number" value={activePizza.price} onChange={e => setMenu(prev => prev.map(p => p.id === activePizzaId ? {...p, price: parseFloat(e.target.value) || 0} : p))} className="bg-transparent border-none text-8xl font-black focus:ring-0 p-0 w-full tracking-tighter italic leading-none" />
                                    </div>

                                    <div className="space-y-12 mb-12">
                                        <div>
                                            <div className="flex justify-between items-end mb-3">
                                                <span className="text-xs font-black text-slate-400 uppercase tracking-[0.2em] italic">CMV Modular</span>
                                                <span className={`text-4xl font-black italic leading-none ${activePizza.cmv > 35 ? 'text-red-600' : 'text-slate-950'}`}>{activePizza.cmv.toFixed(1)}%</span>
                                            </div>
                                            <div className="h-5 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner p-[2px]">
                                                <div className={`h-full transition-all duration-1000 ease-out rounded-full ${activePizza.cmv > 35 ? 'bg-red-600 shadow-[0_0_15px_rgba(220,38,38,0.3)]' : 'bg-green-600'}`} style={{ width: `${Math.min(100, activePizza.cmv)}%` }}></div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-200/50 text-center leading-none">
                                                <p className="text-[10px] font-black text-slate-400 uppercase mb-2 leading-none italic">Insumos</p>
                                                <p className="text-xl font-black text-slate-800 tracking-tighter italic">R$ {activePizza.costInsumos.toFixed(2)}</p>
                                            </div>
                                            <div className="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-200/50 text-center leading-none">
                                                <p className="text-[10px] font-black text-slate-400 uppercase mb-2 leading-none italic">Lucro Liq.</p>
                                                <p className="text-xl font-black text-green-600 tracking-tighter italic">R$ {activePizza.margin.toFixed(2)}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="bg-slate-950 text-white p-10 rounded-[3.5rem] flex justify-between items-center group relative overflow-hidden transition-all hover:scale-[1.03]">
                                            <div className="relative z-10 leading-none">
                                                <p className="text-[11px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2 leading-none italic tracking-widest italic">Equilíbrio</p>
                                                <p className="text-5xl font-black italic tracking-tighter leading-none">{activePizza.margin > 0 ? Math.ceil(fixedCosts / activePizza.margin) : '---'}</p>
                                                <p className="text-[10px] font-bold text-slate-500 uppercase mt-3 tracking-widest italic leading-none">unid / mês</p>
                                            </div>
                                            <Icon name="target" size={44} className="text-red-600 opacity-60 relative z-10" />
                                        </div>
                                    </div>
                                    <button onClick={() => setView('menu')} className="w-full bg-slate-900 text-white font-black py-6 rounded-[3rem] mt-10 hover:bg-black transition-all active:scale-95 shadow-2xl uppercase tracking-[0.2em] text-[10px]">Voltar ao Cardápio</button>
                                </div>
                            </div>
                        </div>

                        {/* MODAL IA COMANDO */}
                        {showAiConsole && (
                            <div className="fixed inset-0 bg-black/90 backdrop-blur-2xl z-[100] flex items-center justify-center p-6 animate-in fade-in duration-300">
                                <div className="bg-slate-900 border border-slate-800 w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden">
                                    <div className="p-10 border-b border-slate-800 flex justify-between items-center bg-indigo-600/10">
                                        <div className="flex items-center gap-4 text-white">
                                            <div className="bg-indigo-600 p-3 rounded-2xl shadow-lg shadow-indigo-900/40"><Icon name="sparkles" /></div>
                                            <h2 className="text-2xl font-black italic uppercase tracking-tighter">Chef AI Command</h2>
                                        </div>
                                        <button onClick={() => setShowAiConsole(false)} className="text-slate-500 hover:text-white transition-all leading-none"><Icon name="x" size={24}/></button>
                                    </div>
                                    <div className="p-10 space-y-6">
                                        <textarea value={aiPrompt} onChange={(e) => setAiPrompt(e.target.value)} placeholder="Ex: Crie uma pizza de Camarão com Catupiry por 85 reais..." className="w-full bg-slate-950 p-6 rounded-[2rem] border border-slate-800 text-lg font-bold text-slate-300 min-h-[150px] outline-none shadow-inner resize-none focus:border-indigo-500 transition-all" />
                                        <button onClick={handleChefAi} disabled={isAiLoading || !aiPrompt} className="w-full bg-white text-slate-950 py-5 rounded-[1.5rem] font-black uppercase text-xs tracking-widest hover:bg-indigo-600 hover:text-white transition-all shadow-2xl flex items-center justify-center gap-3 active:scale-95 disabled:opacity-50">
                                            {isAiLoading ? <Icon name="loader-2" className="animate-spin"/> : <Icon name="send" size={18}/>} 
                                            {isAiLoading ? 'Processando...' : 'Adicionar via IA'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>